Serial Parrallel Interface (SPI) er en måde at lave hurtig seriel dataudveksling på. SPI er udviklet af Motorola og fungerer ved at man, som regel, har en enkelt masterenhed der styrer flere slaveenheder. Ved SPI er der er ingen fejl-check og adressering af flere enheder kan være HW krævende. I EasyWater8000 projektet er der SPI kommunikation imellem Master (Devkit8000)
og Enhed (PSoC4), det giver muligheden for at overføre flere data på samme tid imellem disse to.

\begin{figure}[H] \centering
{\includegraphics[width=\textwidth]{filer/design/Billeder/SPI_MASTER_SLAVE}}
\caption{SPI}
\label{lab:SPI}
\raggedright
\end{figure}

På figur \ref{lab:SPI} ses en typisk opkobling imellem Master og Slave, det kræver 4 tråde.
\begin{itemize}
 	\item SS står for "Slave select".
 	\item MISO står for "Master in slave out".
 	\item MOSI står for "Master out slave in". 
	\item SCLK står for "Serial clock" 
\end{itemize}

SPI-kommunikation er baseret på skifteregisterprincippet, som ses på figur \ref{lab:SPI_REGISTER}. Der vælges hvilken slave der 
ønskes at skrives til ved slave select(SS), derefter shiftes et 8-bit register 1 bit ad gangen. Serial clock er den clock der sørger for at
shiftningen af bits sker korrekt, clockfrekvensen må ikke overstige grænsen for hvad enhederne kan håndtere.

\begin{figure}[H] \centering
{\includegraphics[width=\textwidth]{filer/design/Billeder/SPI_REGISTER}}
\caption{SPI register}
\label{lab:SPI_REGISTER}
\raggedright
\end{figure}  

En ofte anvendt kommunikation imellem master og slave foregår ved at master sætter SS til 0. Den fortæller nu til slaven at den er klar til 
dataoverførsel. Nu sender masteren en bit over til slaven og påbegynder en half-duplex data transmission, samtidigt sender slaven en bit over til masteren. Denne process fortsætter indtil masteren har sendt alle sine bits, derefter stopper masteren med at toggle på clocken og slave enheder bliver frigivet.

SPI kan køre både full- og halfduplex, dvs. at der kan være 2-vejs kommunikation ved full-duplex (flere masterenheder) eller 2-vejs kommunikation ved half-duplex, hvor en masterenhed styrer/skriver til en eller flere slaveenheder. I EasyWater8000 er der behov for at der kommunikeres 2 veje, men da Enheden fungerer som slave, kan den ikke selvstændigt sende til Masteren, men behøver et kald, om at nu skal den sende information. Derfor er det half-duplex der bruges.

\subsection{Kernemodul og Driver}

I SPI-kommunikationen er der taget udgangspunkt i HAL Exercise 7\footnote{Hardware abstraktioner. Exercise 7: LDD with SPI. Øvelse med SPI-kommunikation}, der er dog lavet kraftigt om i driveren, så det tilpasses EasyWater8000s behov. Kernemodulet er der ikke lavet de store ændringer i så denne beskrives ikke i projektet.

Driveren opbygges med en skrive- og læsemetode, der begge kan læse eller skrive én 8 bits karakter(char).

\begin{lstlisting}[language=C]
int write(data){
Write 1 char to SPI network
}
int read(*datapointer){
Read data
Move data to datapointer
}
\end{lstlisting}

% SPI API

\subsection{SPI API}
\input{filer/design/hw_spi_api}


% SPI HANDLER

\subsection{SPI Handler}
\input{filer/design/hw_spi_handler}